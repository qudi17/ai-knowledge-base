---
tags: [learning/notes, rag, retrieval, anthropic]
created: 2026-02-28
related: [[Contextual Retrieval-å­¦ä¹ è®¡åˆ’]]
---

# ğŸ“ å­¦ä¹ ç¬”è®°ï¼šContextual Retrieval

**æ¥æº**ï¼šhttps://www.anthropic.com/engineering/contextual-retrieval  
**å‘å¸ƒæ—¥æœŸ**ï¼š2024  
**ä½œè€…**ï¼šDaniel Ford (Anthropic)

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

### è¿™ç¯‡åšå®¢è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

**ä¼ ç»Ÿ RAG çš„æ ¸å¿ƒé—®é¢˜**ï¼šæ–‡æ¡£åˆ†å—åä¸¢å¤±ä¸Šä¸‹æ–‡ï¼Œå¯¼è‡´æ£€ç´¢å¤±è´¥

**ä¾‹å­**ï¼š
- åŸå§‹ chunkï¼š`"The company's revenue grew by 3% over the previous quarter."`
- é—®é¢˜ï¼šè¿™ä¸ª chunk æ²¡æœ‰è¯´æ˜æ˜¯å“ªä¸ªå…¬å¸ã€å“ªä¸ªæ—¶é—´æ®µ
- ç”¨æˆ·é—®ï¼š`"What was the revenue growth for ACME Corp in Q2 2023?"`
- ç»“æœï¼šæ£€ç´¢ç³»ç»Ÿæ‰¾ä¸åˆ°è¿™ä¸ª chunkï¼ˆç¼ºå°‘å…¬å¸åå’Œæ—¶é—´ï¼‰

---

### ç°æœ‰æ–¹æ³•çš„å±€é™æ€§æ˜¯ä»€ä¹ˆï¼Ÿ

**ä¼ ç»Ÿ RAG æµç¨‹**ï¼š
```
æ–‡æ¡£ â†’ åˆ†å— â†’ Embedding â†’ å‘é‡æ•°æ®åº“ â†’ æ£€ç´¢
```

**é—®é¢˜**ï¼š
1. **è¯­ä¹‰ Embedding**ï¼šæ“…é•¿è¯­ä¹‰å…³ç³»ï¼Œä½†ä¸¢å¤±ç²¾ç¡®åŒ¹é…
2. **BM25**ï¼šæ“…é•¿ç²¾ç¡®åŒ¹é…ï¼Œä½†ç¼ºå°‘è¯­ä¹‰ç†è§£
3. **ä¸¤è€…ç»“åˆ**ï¼šä»ç„¶ä¸¢å¤±æ–‡æ¡£çº§ä¸Šä¸‹æ–‡

**å…¶ä»–å°è¯•çš„æ–¹æ¡ˆ**ï¼š
- æ·»åŠ é€šç”¨æ–‡æ¡£æ‘˜è¦ â†’ æ•ˆæœæœ‰é™
- Hypothetical Document Embedding â†’ æ€§èƒ½ä½
- Summary-based Indexing â†’ æ€§èƒ½ä½

---

### ä½œè€…æå‡ºçš„æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿ

**Contextual Retrieval** = Contextual Embeddings + Contextual BM25

**æ ¸å¿ƒæ€è·¯**ï¼šä¸ºæ¯ä¸ª chunk æ·»åŠ  chunk-specific çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

**è½¬æ¢ç¤ºä¾‹**ï¼š
```
åŸå§‹ chunk:
"The company's revenue grew by 3% over the previous quarter."

Contextualized chunk:
"This chunk is from an SEC filing on ACME corp's performance in Q2 2023; 
the previous quarter's revenue was $314 million. 
The company's revenue grew by 3% over the previous quarter."
```

---

## ğŸ“š å…³é”®æ¦‚å¿µ

| æ¦‚å¿µ | å®šä¹‰ | æˆ‘çš„ç†è§£ | ç–‘é—® |
|------|------|---------|------|
| **Contextual Embeddings** | åœ¨ embedding å‰ä¸º chunk æ·»åŠ ä¸Šä¸‹æ–‡ | è®© embedding æ¨¡å‹"çŸ¥é“"è¿™ä¸ª chunk çš„èƒŒæ™¯ | ä¸Šä¸‹æ–‡å¦‚ä½•ç”Ÿæˆï¼Ÿ |
| **Contextual BM25** | åœ¨ BM25 ç´¢å¼•å‰ä¸º chunk æ·»åŠ ä¸Šä¸‹æ–‡ | è®© BM25 ä¹Ÿèƒ½åŒ¹é…åˆ°ä¸Šä¸‹æ–‡ä¿¡æ¯ | ä¸æ™®é€š BM25 åŒºåˆ«ï¼Ÿ |
| **Reranking** | æ£€ç´¢åé‡æ–°æ’åº | ä»å¤§é‡å€™é€‰ä¸­ç²¾é€‰æœ€ç›¸å…³çš„ | ç”¨ä»€ä¹ˆæ¨¡å‹ï¼Ÿ |
| **Prompt Caching** | Claude çš„ç¼“å­˜ç‰¹æ€§ | é™ä½ Contextual Retrieval æˆæœ¬çš„å…³é”® | å¦‚ä½•å·¥ä½œï¼Ÿ |

---

## ğŸ”§ æ ¸å¿ƒæ–¹æ³•/æŠ€æœ¯

### æ–¹æ³• 1ï¼šContextual Embeddings

**åŸç†**ï¼š
åœ¨ embedding ä¹‹å‰ï¼Œä½¿ç”¨ LLM ä¸ºæ¯ä¸ª chunk ç”Ÿæˆä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç„¶å prepend åˆ° chunk å‰å† embeddingã€‚

**æ­¥éª¤**ï¼š
1. å°†æ–‡æ¡£åˆ†å—ï¼ˆ~800 tokensï¼‰
2. ä½¿ç”¨ Claude ä¸ºæ¯ä¸ª chunk ç”Ÿæˆä¸Šä¸‹æ–‡ï¼ˆ50-100 tokensï¼‰
3. å°†ä¸Šä¸‹æ–‡ prepend åˆ° chunk
4. å¯¹ contextualized chunk åš embedding

**ä¸Šä¸‹æ–‡ç”Ÿæˆ Prompt**ï¼š
```
<document>
{{WHOLE_DOCUMENT}}
</document>
Here is the chunk we want to situate within the whole document
<chunk>
{{CHUNK_CONTENT}}
</chunk>
Please give a short succinct context to situate this chunk within the overall document 
for the purposes of improving search retrieval of the chunk. 
Answer only with the succinct context and nothing else.
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¿ç•™æ–‡æ¡£çº§ä¸Šä¸‹æ–‡
- âœ… æé«˜è¯­ä¹‰æ£€ç´¢å‡†ç¡®ç‡
- âœ… å‡å°‘æ£€ç´¢å¤±è´¥ç‡ 35%

**å±€é™æ€§**ï¼š
- âš ï¸ éœ€è¦é¢å¤–çš„ LLM è°ƒç”¨æˆæœ¬
- âš ï¸ é¢„å¤„ç†æ—¶é—´å¢åŠ 

---

### æ–¹æ³• 2ï¼šContextual BM25

**åŸç†**ï¼š
åœ¨åˆ›å»º BM25 ç´¢å¼•å‰ï¼ŒåŒæ ·ä¸º chunk æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚

**æ­¥éª¤**ï¼š
1. ä½¿ç”¨åŒæ ·çš„ä¸Šä¸‹æ–‡ç”Ÿæˆæ–¹æ³•
2. å°† contextualized chunk åˆ›å»º BM25 ç´¢å¼•
3. æ£€ç´¢æ—¶åŒæ—¶ä½¿ç”¨ Contextual Embeddings å’Œ Contextual BM25
4. ä½¿ç”¨ rank fusion åˆå¹¶ç»“æœ

**ä¼˜åŠ¿**ï¼š
- âœ… ä¿ç•™ç²¾ç¡®åŒ¹é…èƒ½åŠ›
- âœ… ä¸Šä¸‹æ–‡ä¿¡æ¯ä¹Ÿå¯è¢« BM25 åŒ¹é…
- âœ… ç»“åˆåæ£€ç´¢å¤±è´¥ç‡é™ä½ 49%

---

### æ–¹æ³• 3ï¼šRerankingï¼ˆå¯é€‰å¢å¼ºï¼‰

**åŸç†**ï¼š
åœ¨åˆæ­¥æ£€ç´¢åï¼Œä½¿ç”¨ reranking æ¨¡å‹å¯¹å€™é€‰ chunks é‡æ–°æ’åºã€‚

**æ­¥éª¤**ï¼š
1. åˆæ­¥æ£€ç´¢ top-150 chunks
2. ä½¿ç”¨ reranking æ¨¡å‹ï¼ˆå¦‚ Cohere Rerankï¼‰è¯„åˆ†
3. é€‰æ‹© top-20 chunks é€å…¥ LLM

**ä¼˜åŠ¿**ï¼š
- âœ… è¿›ä¸€æ­¥ç­›é€‰æœ€ç›¸å…³ä¿¡æ¯
- âœ… å‡å°‘ LLM å¤„ç†çš„ token æ•°
- âœ… ç»“åˆåæ£€ç´¢å¤±è´¥ç‡é™ä½ 67%

**æˆæœ¬è€ƒè™‘**ï¼š
- âš ï¸ å¢åŠ é¢å¤–å»¶è¿Ÿ
- âš ï¸ å¢åŠ  reranking æˆæœ¬

---

## ğŸ“Š å…³é”®æ€§èƒ½æ•°æ®

| æ–¹æ³• | æ£€ç´¢å¤±è´¥ç‡ | æ”¹è¿› |
|------|----------|------|
| **Baseline (Embeddings only)** | 5.7% | - |
| **+ Contextual Embeddings** | 3.7% | â†“ 35% |
| **+ Contextual BM25** | 2.9% | â†“ 49% |
| **+ Reranking** | 1.9% | â†“ 67% |

**æµ‹è¯•æ¡ä»¶**ï¼š
- Embedding æ¨¡å‹ï¼šGemini Text 004
- æ£€ç´¢æ•°é‡ï¼štop-20 chunks
- è¯„ä¼°æŒ‡æ ‡ï¼š1 - recall@20

---

## ğŸ’° æˆæœ¬åˆ†æ

### Contextual Retrieval é¢„å¤„ç†æˆæœ¬

**å‡è®¾**ï¼š
- Chunk å¤§å°ï¼š800 tokens
- æ–‡æ¡£å¤§å°ï¼š8,000 tokens
- ä¸Šä¸‹æ–‡æŒ‡ä»¤ï¼š50 tokens
- æ¯ä¸ª chunk ä¸Šä¸‹æ–‡ï¼š100 tokens

**æˆæœ¬**ï¼ˆä½¿ç”¨ Prompt Cachingï¼‰ï¼š
- **$1.02 / ç™¾ä¸‡æ–‡æ¡£ tokens**ï¼ˆä¸€æ¬¡æ€§æˆæœ¬ï¼‰

**ä¸ºä»€ä¹ˆä¾¿å®œ**ï¼š
- Prompt Caching è®©æ–‡æ¡£åªéœ€åŠ è½½ä¸€æ¬¡
- åç»­ chunks å¤ç”¨ç¼“å­˜çš„æ–‡æ¡£

---

## ğŸ—ï¸ å®Œæ•´æ¶æ„æµç¨‹

```
é¢„å¤„ç†é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ–‡æ¡£      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆ†å—      â”‚ (800 tokens/chunk)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”Ÿæˆä¸Šä¸‹æ–‡   â”‚ (Claude Haiku, 50-100 tokens)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Prepend ä¸Šä¸‹æ–‡â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Embedding   â”‚     â”‚  BM25 Index â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å‘é‡æ•°æ®åº“ + BM25 ç´¢å¼•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ£€ç´¢é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æŸ¥è¯¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Embedding   â”‚     â”‚    BM25     â”‚
â”‚   æ£€ç´¢      â”‚     â”‚   æ£€ç´¢      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Rank Fusion åˆå¹¶         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  (å¯é€‰) Rerank â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  Top-20 Chunks â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚     Claude    â”‚
       â”‚   ç”Ÿæˆå›ç­”     â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¤” æˆ‘çš„ç–‘é—®

- [ ] Contextual BM25 ä¸æ™®é€š BM25 çš„å…·ä½“å®ç°å·®å¼‚ï¼Ÿ
- [ ] Rank Fusion ä½¿ç”¨ä»€ä¹ˆç®—æ³•ï¼Ÿï¼ˆRRF?ï¼‰
- [ ] Reranking æ¨¡å‹çš„é€‰æ‹©æ ‡å‡†ï¼Ÿ
- [ ] å¯¹äºä¸­æ–‡æ–‡æ¡£æ•ˆæœå¦‚ä½•ï¼Ÿ
- [ ] ä¸Šä¸‹æ–‡ç”Ÿæˆçš„è´¨é‡å¦‚ä½•ä¿è¯ï¼Ÿ

---

## ğŸ’¡ æˆ‘çš„æ´å¯Ÿ

### æ´å¯Ÿ 1ï¼šä¸Šä¸‹æ–‡æ˜¯å…³é”®

ä¼ ç»Ÿ RAG çš„é—®é¢˜ä¸æ˜¯ embedding æˆ– BM25 ä¸å¤Ÿå¥½ï¼Œè€Œæ˜¯**è¾“å…¥æœ¬èº«å°±ä¸¢å¤±äº†ä¸Šä¸‹æ–‡**ã€‚

å°±åƒç»™äººä¸€å¥è¯ä½†æ²¡æœ‰èƒŒæ™¯ï¼Œå¾ˆéš¾ç†è§£å®Œæ•´æ„æ€ã€‚

---

### æ´å¯Ÿ 2ï¼šæˆæœ¬ä¸æ•ˆæœçš„å¹³è¡¡

- **ç®€å•æ–¹æ¡ˆ**ï¼šå¦‚æœçŸ¥è¯†åº“ < 200K tokensï¼Œç›´æ¥å…¨éƒ¨æ”¾å…¥ promptï¼ˆç”¨ Prompt Cachingï¼‰
- **ä¸­ç­‰è§„æ¨¡**ï¼šContextual Retrieval
- **å¤§è§„æ¨¡**ï¼šContextual Retrieval + Reranking

---

### æ´å¯Ÿ 3ï¼šLLM ä½œä¸ºé¢„å¤„ç†å·¥å…·

ç”¨ LLM ç”Ÿæˆä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ªå·§å¦™çš„åº”ç”¨ï¼š
- ä¸æ˜¯ç›´æ¥å›ç­”é—®é¢˜
- è€Œæ˜¯ä¸ºä¸‹æ¸¸ä»»åŠ¡ï¼ˆæ£€ç´¢ï¼‰åšé¢„å¤„ç†
- ä¸€æ¬¡æ€§æˆæœ¬ï¼Œé•¿æœŸå—ç›Š

---

## ğŸ”— ä¸å…¶ä»–çŸ¥è¯†çš„è¿æ¥

- è¿æ¥ [[RAG åŸºç¡€]]ï¼šä¼ ç»Ÿ RAG çš„æ”¹è¿›æ–¹æ¡ˆ
- è¿æ¥ [[Embedding æŠ€æœ¯]]ï¼šè¯­ä¹‰æ£€ç´¢çš„æ ¸å¿ƒ
- è¿æ¥ [[BM25 ç®—æ³•]]ï¼šç²¾ç¡®åŒ¹é…çš„æ ¸å¿ƒ
- è¿æ¥ [[Prompt Caching]]ï¼šé™ä½æˆæœ¬çš„å…³é”®

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [Contextual Embeddings Cookbook](https://platform.claude.com/cookbook/capabilities-contextual-embeddings-guide)
- [Prompt Caching Cookbook](https://platform.claude.com/cookbook/misc-prompt-caching)
- [Appendix II - è¯¦ç»†æ•°æ®](https://assets.anthropic.com/m/1632cded0a125333/original/Contextual-Retrieval-Appendix-2.pdf)

---

**æœ€åæ›´æ–°**ï¼š2026-02-28  
**çŠ¶æ€**ï¼šğŸŸ¡ è¿›è¡Œä¸­
